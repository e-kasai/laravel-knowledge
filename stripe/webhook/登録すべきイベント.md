
---

登録すべきイベント（最小）

checkout.session.completed

役割：Checkout完了（＝支払い確定とは限らない）

処理：payment_intent_id / checkout_session_id を保存、配送先もここで吸う

カードなら同時に payment_status=paid になってることが多いが、最終確定は次のイベントで担保

payment_intent.succeeded（必須）

役割：入金確定（カード確定 / コンビニ入金後）

処理：payment_status=1(paid), paid_at セット、charge_id 保存（latest_charge から取得）

payment_intent.payment_failed

役割：決済失敗（カード拒否など）

処理：payment_status=2(canceled/failed)、理由ログ保存

payment_intent.canceled

役割：期限切れ・ユーザー中断（コンビニの支払期限切れ等）

処理：payment_status=2、canceled_at セット、在庫解放

checkout.session.expired（任意だが便利）

役割：セッション未使用のまま有効期限切れ

処理：仮予約してたら解放（pending→解放）

テーブル項目とのマッピング

payment_intent_id：上記すべてのPI系イベントのキー。必須

charge_id：payment_intent.succeeded で event.data.object.latest_charge から保存

payment_status：

succeeded → 1:paid

payment_failed / canceled / session.expired → 2:canceled

session.completed（コンビニ等の非即時）→ 0:pending 維持

paid_at：payment_intent.succeeded 受信時にセット

canceled_at：payment_intent.canceled / session.expired / payment_failed でセット