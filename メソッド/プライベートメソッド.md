
---

- クラスの中だけで使えるメソッド
- 同じ処理を複数のメソッドで使うとき、プライベートメソッドにまとめると修正も一箇所で済むしきれい

---

#### 使い方

#### Before
```php
//何度もおなじ処理を書いている、、、
<?php

class PurchaseController extends Controller
{
    public function showPurchasePage(Item $item)
    {
        $user = auth()->user();
        $profile = $user->profile;

        $originalAddress = [
            'postal_code' => $profile?->postal_code,
            'address'     => $profile?->address,
            'building'    => $profile?->building,
        ];

        // UI側で購入ボタンを無効化するためのフラグ
        $canPurchase = (bool) $profile;
        $draftAddress = session("draft_address.{$item->id}", []);
        // 想定キーだけに限定（予期せぬキーの混入防止）
        $draftAddress = array_intersect_key($draftAddress, $originalAddress);
        // 差分merge：draftAddressが優先（buildingはnullならnullで上書き）
        $shippingAddress = array_replace($originalAddress, $draftAddress);

        return view('purchase', compact('item', 'profile', 'shippingAddress', 'canPurchase'));
    }


    // 配送先変更画面表示
    public function showShippingAddress(Item $item)
    {
        $user = auth()->user();
        $profile = $user->profile;

        $originalAddress = [
            'postal_code' => $profile?->postal_code,
            'address'     => $profile?->address,
            'building'    => $profile?->building,
        ];

        $draftAddress = session("draft_address.{$item->id}", []);
        $draftAddress = array_intersect_key($draftAddress, $originalAddress);
        $shippingAddress = array_replace($originalAddress, $draftAddress);

        return view('shipping_address', [
            'item'            => $item,
            'shippingAddress' => $shippingAddress,
        ]);
    }

```

#### After
```php
//重複処理はまとめてすっきり
<?php

class PurchaseController extends Controller
{
    public function showPurchasePage(Item $item)
    {
        $user = auth()->user();
        $profile = $user->profile;
        $shippingAddress = $this->buildShippingAddress($item, $profile); //ここで呼び出し
        // UI側で購入ボタンを無効化するためのフラグ
        $canPurchase = (bool) $profile;
        return view('purchase', compact('item', 'profile', 'shippingAddress', 'canPurchase'));
    }


    // 配送先変更画面表示
    public function showShippingAddress(Item $item)
    {
        $user = auth()->user();
        $profile = $user->profile;
        $shippingAddress = $this->buildShippingAddress($item, $profile); //ここで呼び出し

        return view('shipping_address', [
            'item' => $item,
            'shippingAddress' => $shippingAddress,
        ]);
    }

    // プライベートメソッド
    private function buildShippingAddress(Item $item, ?Profile $profile): array //? = nullも許す（エラー回避）
    {
        // プロフィールのデフォルト値
        $originalAddress = [
            'postal_code' => $profile?->postal_code,
            'address'     => $profile?->address,
            'building'    => $profile?->building,
        ];

        // セッションにあるドラフト（存在しなければ []）
        $draftAddress = session("draft_address.{$item->id}", []);
        // 想定外キーの排除
        $draftAddress = array_intersect_key($draft, $original);
        // ドラフト優先でマージ
        return array_replace($originalAddress, $draftAddress);
    }
}
```
---
#### 呼び出し文の解説

- $this->
「このクラス自身（= 今いるコントローラのインスタンス）」を指す。
プライベートメソッドはクラスの中専用なので、$this->メソッド名() の形で呼ぶ。

- buildShippingAddress($item, $profile)
先ほど定義したプライベートメソッドを呼び出し。引数を渡す。
渡されたものを使って、メソッドの中で住所配列を組み立てる。

- $shippingAddress = ...
メソッドが返した配列（returnの結果）を、 $shippingAddress という変数に代入。
この変数は 呼び出し側（showPurchasePage内）で新しく作られるもので任意のものでいい。
