
DB::transaction()

---

Laravelで言う **トランザクション** は、データベース処理を「全部まとめて成功させる or 失敗させる」という仕組み。  
簡単に言うと **「All or Nothing」** で安全にデータを扱うための機能です。

---

### **イメージ**

銀行振込

1. Aさんの口座から1万円引き落とす
    
2. Bさんの口座に1万円振り込む
    

この2つは **セットで成功しないといけない** 処理です。  
片方だけ失敗したら大問題。  
そこでトランザクションを使えば、

- 2つとも成功したら → **確定 (commit)**
    
- どちらかが失敗したら → **取り消し (rollback)**
    

という安全な動きをしてくれます。

---

### **Laravelの書き方**

#### **基本**

```php
DB::transaction(function () {     
	User::find(1)->update(['balance' => 0]);     
	Payment::create(['user_id' => 1, 'amount' => 10000]); 
});`
```
この場合：

- どちらの処理も成功 → **DBに反映**
    
- 途中でエラー → **ロールバック**
    

---

#### **手動管理**

```php
DB::beginTransaction();  try {     
	User::find(1)->update(['balance' => 0]);     
	Payment::create(['user_id' => 1, 'amount' => 10000]);      
	DB::commit(); // 成功 
	} catch (\Exception $e) {     
		DB::rollBack(); // 失敗     
		throw $e; 
	}
```
エラー処理を細かく制御したいときはこちらを使います。

---

### **トランザクションを使う場面**

- **複数のテーブルを一括更新したいとき**  
    例: `users` と `profiles` の両方を更新
    
- **在庫処理や購入処理など失敗が許されない操作**
    
- **途中で失敗したらDBを元に戻したいとき**
    

---

### 使わないとどうなる

在庫を握る部分でトランザクションを使わずに並列処理を許すと──

- ユーザーAとBが**同時に購入ボタン**を押す
    
- 在庫チェックが同時に通過
    
- 2件とも購入処理が走る
    
- 結果：1つしかない商品が**二重売り**
    

こうなると、APIログ・SQLログ・支払い履歴を追いかけて、人力でデータを修復…
**カオス＋パラレル＝カラレルワールドｗ**

---

### **注意点**

- トランザクションは**処理が終わるまでテーブルをロック**することがあるので、処理は短くまとめる。
    
- ネストはなるべく避け、外側でまとめるのが基本。
    
- `DB::afterCommit()` などと組み合わせると、DB確定後の処理を安全に書ける。
    

---

### **まとめ**

- トランザクションは **「まとめて確定、失敗したら全部取り消す」** 機能
    
- データの整合性を守るために **複数テーブル更新や重要処理では必須**
    
- Laravelでは `DB::transaction()` が一番簡単で安全