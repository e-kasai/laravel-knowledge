

### **悲観ロックとは**

- **「他のトランザクションが触る可能性がある」**と最初から考えて
    
- レコードを取得した瞬間に**ロック**をかける方式。
    
- ロック中は他の処理がそのレコードを更新しようとすると待たされる。
    

---

### **Laravelの書き方**


```php
DB::transaction(function () use ($itemId) { 
   
	$item = Item::where('id', $itemId)         
		->lockForUpdate()         
		->first();      
	if ($item->is_sold) {         
		throw new \Exception('売り切れです');
	 }      
	 
	 $item->update(['is_sold' => true]); 
 });
```

---

### **フリマアプリでは悲観ロック必須**

同時購入が発生したときに：

- 最初のユーザーがロックを取る
    
- 2人目のユーザーはロック解除まで待機
    
- 結果、**二重売りが防止**できる
    

---

たしかに名前は悲しいけど、フリマ開発では頼もしさMAXの**「悲観的ヒーロー」**