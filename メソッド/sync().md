
---

#### 概要

`sync()` は **多対多（belongsToMany）リレーション**で使うメソッド。  
**挙動タイプは上書き**

---

#### 挙動イメージ（変更時）

* 例：商品ID=10 に対して カテゴリID [1,3,5] がすでに登録されている状態で
 新しく カテゴリID [2,4] を指定してsync([2,4]) を実行する

```php
$item = Item::find(10); // 商品ID=10 を取得
$item->categories()->sync([2, 4]); // カテゴリID [2,4] を同期
```

`sync 前`

| id | item_id | category_id |
|----|---------|-------------|
| 1  | 10      | 1           |
| 2  | 10      | 3           |
| 3  | 10      | 5           |

`sync 後（sync([2,4]))`

| id | item_id | category_id |
|----|---------|-------------|
| 4  | 10      | 2           |
| 5  | 10      | 4           |


** ポイント **

* 古い [1,3,5] の関連は削除される
* 新しく [2,4] が登録される
* id の値は AUTO_INCREMENT なので続き番号になる
   

---

#### 挙動イメージ（初回）

```php
// 例: 新規作成後にカテゴリを紐付け 
// 出品者 = ログイン中ユーザーとして商品を新規作成
$item = auth()->user()->items()->create($validated); 
// 新規商品にカテゴリを関連づけ
$item->categories()->sync($validated['category_ids']);
```

#### 初回の処理の流れ

`$item = auth()->user()->items()->create($validated);`

**役割**
- ログイン中のユーザー（出品者）に紐づく商品を **itemsテーブル** に新規登録
- `$item` には「登録された商品のEloquentモデル」が入る

**イメージ図**

usersテーブル

| id | name |
|----|------|
|  5 | 太郎 |

itemsテーブル

| id | seller_id | item_name |
|----|-----------|-----------|
| 10 |     5     | Tシャツ   |

`$item->categories()->sync($validated['category_ids']);`

**役割**
- 新しく作った `$item` と、選択されたカテゴリID（配列）を **中間テーブル `category_item`** で紐付け

**イメージ図**  
送信データ（例）:
`$validated['category_ids'] = [1, 3, 5];`

登録結果:
`category_itemテーブル` 

| id | item_id | category_id |
|----|---------|-------------|
|  1 |   10    |      1      |
|  2 |   10    |      3      |
|  3 |   10    |      5      |

---

## まとめると

- **itemsテーブル** に「商品データ」を保存
    
- **category_itemテーブル** に「商品IDとカテゴリIDのセット」を登録  
    → これで、1つの商品が複数カテゴリと関連付けられる状態になります。
`$validated['category_ids']` が `[1,3,5]` の場合：
`category_item（中間テーブル）` に `item_id` と `category_id=1,3,5` を保存

---

#### `attach()` との違い

|メソッド|挙動|
|---|---|
|`attach()`|追加のみ。既存データは残る。|
|`sync()`|完全同期。差分を削除・追加して最新状態に保つ。|

---

#### 注意点

- 渡した配列は **バリデーション必須**（存在しないIDや重複を防ぐため）
    
- 空配列を渡すと **関連付けが全削除** されるので注意
    


---




