---
tags: 中間テーブル
---

## 基本構造

多対多（Many-to-Many）の関係を扱うときに使う。

例：
- **items**（商品）
- **categories**（カテゴリ）
- **category_item**（中間テーブル）

---

## リレーション定義

### Itemモデル側

```php
// app/Models/Item.php
 public function categories() {     
	 return $this->belongsToMany(Category::class, 'category_item', 'item_id', 'category_id'); }
```
---

### Categoryモデル側

```php
// app/Models/Category.php 
public function items() {     
	return $this->belongsToMany(Item::class, 'category_item', 'category_id', 'item_id'); }
```

---

## 外部キー順序のルール（重要！

- **第2引数** → **中間テーブル名**
- **第3引数** → **自分側モデルの外部キー**
- **第4引数** → **相手側モデルの外部キー**

第３引数と第４引数の順番を間違えるとeloquentが間違えてSQLを組むので、結果が壊れる
必ず第３引数が自分側、第４引数が相手側のキーになるようにする

---
## 外部キーの省略ルール
第２、第３、第４引数は全て省略可（デフォルト設定の場合）

✅ 省略できるケース

中間テーブル名 → モデル名（スネークケース単数形）をアルファベット順につなげたもの
例: Category モデルと Item モデル → 中間テーブル名は category_item

外部キー名 → モデル名単数形_id
例: category_id, item_id

このときは↓のようにシンプルに書ける：
```php
// Item モデル
public function categories()
{
    return $this->belongsToMany(Category::class);
}
```

❌ 規約から外れた場合

中間テーブル名を favorites にした
外部キー名を userId や product_id にした

こういう場合は必ず引数で指定する必要がある：
```php
// Item モデル
public function favoritedByUsers()
{
    return $this->belongsToMany(User::class, 'favorites', 'item_id', 'user_id');
}
```


📌 まとめ
両方が規約どおり → 引数省略OK
どちらか片方でも違う → 明示指定が必要

---

## 中間テーブルにPK,FK以外のカラムがある場合　= withPivot()を使う
[[withPivot()]]
中間テーブルに `created_at`, `updated_at`, `note` などのデフォルトカラム以外がありそれらを引っ張ってきたいとき。

デフォルトカラム = 接続に必須なもの
- 中間テーブルのPK
- リレーションする両テーブルのFK

---

## ポイント

- **規則通りの命名**なら `withPivot()` 以外の引数は省略可
- `pivot` プロパティ経由で中間テーブルの値にアクセスできる