---
tags: ミューテタ
---

#### ミューテタの役割
- モデルのカラムに値を入れるときに、Laravelが自動でその値を加工する
- 「代入した瞬間にLaravelがこっそり値を整えてくれる」感じ
- Excelでいうと「セルに入力した瞬間、自動で書式を整える機能」みたいなもの


#### アクセサとの違い

| 比較項目 | ミューテタ（Mutator） | アクセサ（Accessor） |
|-----------|------------------------|------------------------|
| いつ動く？ | 値を セット（代入）するとき | 値を 取得（表示）するとき |
| メソッド名 | set〇〇Attribute() | get〇〇Attribute() |
| 使う場面 | 保存前に自動で加工したいとき | 表示前に自動で加工したいとき |
| 典型例 | パスワードをハッシュ化する | 名前の先頭を大文字にする |
| 動作方向 | データベースに入れる側 | データベースから出す側 |

---

#### 具体例

```php
class User extends Model
{
    // nameが代入されるときに自動で発動
    public function setNameAttribute($value)
    {
        $this->attributes['name'] = ucfirst($value);
    }
}
```

`$user->name` に値を代入した瞬間、setNameAttribute() が呼ばれる

---

#### 動くタイミングと例外

⚙️ 動くタイミング
1. `$model->name` = 'xxx'; と プロパティに代入した瞬間
2. `$model->fill(['name' => 'xxx']);` のとき
3. `$model->update(['name' => 'xxx']);` のとき（モデル経由ならOK）

注意： ただし、`DB::table('users')->update()` のようにクエリビルダ経由だと呼ばれません。

---

#### メリット

ミューテタのメリット　＝　限局性
ミューテタは、「そのカラムに値を代入した瞬間にだけ」発動します。

つまり、
- 他のカラムには影響しない
- どの場面でも意図せず呼ばれにくい

例
```php
public function setEmailAttribute($value)
{
    $this->attributes['email'] = strtolower($value);
}
```

この処理は「emailを代入した時だけ」動きます。
他のカラム（nameやpassword）を触っても発火しません。
→ 意図せぬ副作用が出ずに、単機能・局所的で安全。

---

#### デメリット

⚠️ 弱点①：複数カラムを同時更新したときに、処理の順番がランダム

例えば、勤務時間と休憩時間を同時に更新したいケース：
```php
$attendance->update([
    'clock_in' => '09:00',
    'clock_out' => '18:00',
]);
```


このとき、Eloquentは内部でこんな順序で動くかもしれません：

`setClockInAttribute()`
`setClockOutAttribute()`

でも、別のタイミングでは逆になることもあります。
つまり "どっちを先に処理するか" 保証されない のです。

結果
`setClockOutAttribute() のときに $this->clock_in` がまだ更新前の値だったり、
`setClockInAttribute() のときに $this->clock_out` が未設定だったりして、
`total_time`の計算結果がズレる（またはnullになる） という不具合が起きます。

---

⚠️ 弱点②：DB更新メソッドでは呼ばれない

update() メソッドは、直接クエリを発行するため、実はミューテタは呼ばれません。
```php
Attendance::where('id', $id)
    ->update(['clock_out' => '18:00']);
```

この場合、`setClockOutAttribute()`は動かないので、 `total_time` は自動計算されず、古いままになります。

---

#### 使い分け

| 方法 | 特徴 |
|------|------|
| ミューテタ | 1カラム単体の書き換えに便利。シンプルで見通し良い。 |
| アクセサ（getXxxAttribute） | 表示時に動く。DBには保存しない“動的計算値”向け。 |
| モデルイベント（saving / saved） | 複数カラムに絡む自動計算向け。set順に左右されにくい。 |
