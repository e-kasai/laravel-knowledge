---
tags: モデルイベント
---


#### 役割

- Eloquentモデルのライフサイクルに合わせて自動で呼び出される「イベント」
- Laravelが「モデルが作られた・更新された・削除された」といったタイミングで、書いておいた一連の処理を自動で実行してくれる仕組み

#### まとめ

| 観点 | モデルイベントの特徴 |
|------|----------------------|
| 発動タイミング | 作成・更新・削除などの前後 |
| 登録場所 | モデルの booted() または Observer クラス |
| 用途 | 自動計算・整合性維持・監査ログなど |
| メリット | コントローラーに書かずに、モデル単位で一貫した動作を定義できる |

---

#### いつ使う

- 複数カラムに依存する計算処理
例：出勤・退勤時刻から合計勤務時間を自動算出

- 整合性を保つ更新処理
例：あるレコードが削除されたら関連データも削除

- 監査ログ
例：誰がいつデータを変更したか記録 　　など

---

#### code例

```php
class Attendance extends Model
{
    protected static function booted()
    {
        static::saving(function ($attendance) {
            // 保存前に勤務時間を自動計算
            if ($attendance->clock_in && $attendance->clock_out) {
                $attendance->total_time = $attendance->clock_in->diffInMinutes($attendance->clock_out);
            }
        });

        static::deleted(function ($attendance) {
            // 削除されたときにログを残す
            Log::info("Deleted attendance: {$attendance->id}");
        });
    }
}
```

#### モデルイベント一覧

| イベント名 | 発動タイミング |
|-------------|----------------|
| creating | 新規レコードを作成する直前 |
| created | 新規レコードを作成した直後 |
| updating | 既存レコードを更新する直前 |
| updated | 既存レコードを更新した直後 |
| saving | 作成 or 更新の前（共通） |
| saved | 作成 or 更新の後（共通） |
| deleting | 削除の直前 |
| deleted | 削除の直後 |
| restoring | 論理削除を戻す前 |
| restored | 論理削除を戻した後 |

---

#### メリット
- ミューテタよりも保存前後で発動する点や、複数カラムの処理が可能など柔軟性が高い

---

#### サービスクラスとの使い分け

- ミューテタ　　　　＝　モデルに直接関係する自動処理　　　（例：勤務時間を自動計算する）
- サービスクラス　 ＝　ユーザーの操作に合わせた動作　     （例：出勤ボタンを押したら業務開始という流れを定義する）

####  違いまとめ

モデルイベントは「何かが起きたら自動で反応」
サービスクラスは「人（ユーザー）が起こす操作をまとめる」

