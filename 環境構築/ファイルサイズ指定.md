
---

| チェック項目                     | コマンド / ファイル | 既定値                                  | 推奨値（フリマアプリ想定） |
|----------------------------------|---------------------|------------------------------------------|----------------------------|
| Nginx の client_max_body_size    | nginx.conf          | 1 MB（デフォルトは制限なしだが、カスタムで 1M が多い） | 20 MB                     |
| PHP の upload_max_filesize       | php.ini             | 2 MB                                     | 20 MB                     |
| PHP の post_max_size             | php.ini             | 8 MB                                     | 20 MB                     |

---

#### サイズ調整の基準


| 上限 | メリット | デメリット |
|------|----------|-----------|
| **5&nbsp;MB**  | ・スマホ写真はほぼ入る<br>・通信が速い<br>・S3 保存コストが少ない | ・一眼レフの RAW は無理 |
| **10&nbsp;MB** | ・4K 写真でも安心<br>・そこそこ軽い | ・地方や格安 SIM だとアップロードに時間 |
| **20&nbsp;MB** | ・高解像度ポスター／PDF も送れる | ・アップロードに数十秒<br>・モバイル通信量が多い<br>・ストレージコスト ×4 |


商品画像だけなら 5〜10 MB が世界的に多い設定
（メルカリ 4 MB／ラクマ 10 MB ※2025年9月）

使い分けがベター

通常の写真 → 5 MB

例外：説明書PDFや動画 を許可したい →
「PDF は 20 MB まで可」など 拡張子別に制限

---
#### どう設定するか
Nginx の client_max_body_size
→ リクエスト自体を受け入れる最大サイズ。ここで弾かれると PHP まで届かない。
```php
//default.conf
server {
    listen 80;
    index index.php index.html;
    server_name localhost;
    client_max_body_size 6m;   //6Mに設定

    root /var/www/public;

    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }
}
```

PHP の upload_max_filesize / post_max_size
→ PHP が処理できるサイズ上限。ここが小さいと「Nginxは通ったのにPHPでエラー」になる。
```php
//php.ini
; ---------- Core ----------
date.timezone       = "Asia/Tokyo"
upload_max_filesize = 6M
post_max_size       = 6M     ; ← 必ず upload_max_filesize 以上

; ---------- mbstring ----------
[mbstring]
mbstring.language = "Japanese"
```

つまり どちらか片方だけ大きくしてもダメ で、必ず合わせる必要がある。

---

#### 実務的なポイント

一般的には 3つを同じ値 にそろえる
差をつけると「どこで落ちたのか？」がわかりにくくなってデバッグが面倒。

小さめにするとユーザーが大きな画像をアップロードできずクレームにつながる。
大きすぎるとサーバーに負荷がかかるから、用途に応じてバランスをとる。

#### まとめ

Nginx → PHP → Laravel の順でチェックが走る
バリデーションだけでは Nginx 413 を防げない
